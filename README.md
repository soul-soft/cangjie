# aspire

## è®¸å¯

MIT

æˆ‘ä»¬æ­£åœ¨æ¢ç´¢ Cangjie ä¸ ASP.NET Core çš„æ·±åº¦èåˆï¼Œè‡´åŠ›äºæ‰“é€ ï¼š    
âœ… ç°ä»£åŒ–ï¼šåŸºäºæœ€æ–° .NET æŠ€æœ¯æ ˆçš„å¼€å‘èŒƒå¼    
âœ… è½»é‡çº§ï¼šä½ä¾µå…¥è®¾è®¡ï¼Œé›¶å†—ä½™ä¾èµ–    
âœ… å¯æ‰©å±•ï¼šæ¨¡å—åŒ–æ¶æ„ï¼ŒæŒ‰éœ€ç»„åˆåŠŸèƒ½    
âœ… å¯æ’æ‹”ï¼šé€šè¿‡ gitcode é…ç½®å¿«é€Ÿé›†æˆ
âœ… å¾®æœåŠ¡ï¼šæˆ‘ä»¬ä¹Ÿå°†æŒç»­æ„å»ºå¾®æœåŠ¡ç”Ÿæ€ï¼Œå¼•å…¥äº†`jwt`ã€`oidc`å’Œ`identityServer`æ¥æ„å»ºç»Ÿä¸€çš„èº«ä»½è®¤è¯ä¸­å¿ƒï¼Œä»¥åŠå†…ç½®äº†å¥åº·æ£€æŸ¥åŸºåº§ç”¨äºæ£€æŸ¥æœåŠ¡çš„è¿è¡Œçš„å¥åº·çŠ¶å†µï¼Œåç»­æˆ‘ä»¬è¿˜å°†å¼•å…¥`dapr`å’Œ`openapi`çš„å®ç°    
âœ… AIï¼šæˆ‘ä»¬æŒç»­å…³æ³¨aiæŠ€æœ¯ï¼Œä»¥åŠæ¢è®¨aièå…¥åº”ç”¨çš„å¯èƒ½æ€§    

è¯šé‚€å¿—åŒé“åˆçš„å¼€å‘è€…åŠ å…¥ aspire ç»„ç»‡ï¼Œå…±åŒæ„å»ºï¼š    
ğŸ”§ æ ‡å‡†åŒ–ç»„ä»¶åº“    
ğŸ”„ ç»Ÿä¸€æŠ€æœ¯ç”Ÿæ€   
ğŸŒ å¼€æºç¤¾åŒºåä½œå¹³å° 
[https://gitcode.com/invite/link/995e1b43629f4773b38c](ç«‹å³åŠ å…¥)    

å¦‚æœä½ æƒ³æ·±å…¥äº†è§£æˆ–è€…æ‰©å±•è¯¥é¡¹ç›®ï¼Œé‚£ä¹ˆä½ å¯ä»¥å­¦ä¹ `aspire_identity_server`,è¯¥é¡¹ç›®å¤§é‡çµæ´»è¿ç”¨äº†`asp`åŸºç¡€ç»„ä»¶å’Œ`asp`è®¾è®¡æ€æƒ³

## å†…ç½®æ¨¡å—

ä¸‹é¢æ˜¯ä¿®å¤åçš„è¡¨æ ¼ï¼Œå…¶ä¸­æ ¼å¼è°ƒæ•´æ­£ç¡®ï¼š

| æ¨¡å—åç§°                                  | æè¿°                         | å¿…è¦æ€§  |
|------------------------------------------|------------------------------|--------|
| aspire_web_http                          | HTTPæ ¸å¿ƒæ¥å£                  | å¿…éœ€    |
| aspire_web_mvc                           | MVC                          | å¯é€‰    |
| aspire_web_routing                       | è·¯ç”±ä¸ç»ˆç»“ç‚¹                  | å¿…éœ€    |
| aspire_web_hosting                       | Webä¸»æœº                       | å¿…éœ€    |
| aspire_web_staticfiles                   | é™æ€æ–‡ä»¶ä¸­é—´ä»¶                | å¯é€‰    |
| aspire_web_healthchecks                  | å¥åº·æ£€æŸ¥ä¸­é—´ä»¶                | å¯é€‰    |
| aspire_web_authorization                 | æˆæƒä¸­é—´ä»¶                     | å¯é€‰    |
| aspire_web_authentication                | èº«ä»½è®¤è¯ä¸­é—´ä»¶                | å¯é€‰    |
| aspire_web_authentication_jwtbearer      | Jwtèº«ä»½è®¤è¯æ–¹æ¡ˆ               | å¯é€‰    |
| aspire_identity_claims                   | èº«ä»½å£°æ˜                      | å¯é€‰    |
| aspire_extensions_hosting                | é€šç”¨ä¸»æœº                      | å¯é€‰    |
| aspire_extensions_logging                | æ—¥å¿—                          | å¯é€‰    |
| aspire_extensions_options                | é€‰é¡¹                         | å¿…éœ€    |
| aspire_extensions_injection              | ä¾èµ–æ³¨å…¥                      | å¯é€‰    |
| aspire_extensions_healthchecks           | å¥åº·æ£€æŸ¥æœåŠ¡                  | å¯é€‰    |
| aspire_extensions_configuration          | é…ç½®ç®¡ç†                      | å¯é€‰    |
| aspire_identity_server                   | OAuth2.0ï¼ŒOIDCè®¤è¯æœåŠ¡         | å¯é€‰    |
| aspire_identity_tokens                   | èº«ä»½ä»¤ç‰Œ                      | å¯é€‰    |
| aspire_identity_tokens_jwt               | Jwtèº«ä»½ä»¤ç‰Œ                    | å¯é€‰    |
| aspire_identity_protocols                | èº«ä»½åè®®                      | å¯é€‰    |
| aspire_identity_protocols_oidc           | OIDCåè®®                      | å¯é€‰    |


## ã€Šä¾èµ–æ³¨å…¥ã€‹

1. åŸºæœ¬ä½¿ç”¨
``` cangjie
//åˆ›å»ºå®¹å™¨æ„å»ºå™¨
let services = ServiceCollection()
//æ³¨å†Œå•ä¾‹æœåŠ¡
services.addSingleton<IDbConnection, DbConnection>()
//å¯ä»¥ä½¿ç”¨å·¥å‚æ¨¡å¼ï¼Œæ¥è§„é¿åå°„
services.addSingleton<IDbConnection>(){ sp =>
    DbConnection()
}
//æ„å»ºå®¹å™¨
let provider = services.build()
//è§£ææœåŠ¡
let connection = provider.getOrThrow<IDbConnection>()
//è§£ææœªæ³¨å†Œçš„æœåŠ¡ï¼Œä½†æ˜¯ä¾èµ–å®¹å™¨ä¸­çš„æœåŠ¡
let context = ActivatorUtilities.createInstance<DbContext>(provider)
```

2. ç”Ÿå‘½å‘¨æœŸ


| å‘¨æœŸ                                               | è¯´æ˜                                                     |
|---------------------------------------------------|----------------------------------------------------------|
| **Singleton**                                     | å•ä¾‹ï¼šä¸€ä¸ªæ ¹å®¹å™¨åŠå…¶å­å®¹å™¨ï¼Œåªåˆ›å»ºä¸€ä¸ªå®åˆ—                   |
| **Scoped**                                        | ä½œç”¨åŸŸï¼šåŒä¸€ä¸ªä½œç”¨åŸŸåªåˆ›å»ºä¸€ä¸ªå®åˆ—ï¼Œç”Ÿå‘½å‘¨æœŸç”±ä¸šåŠ¡å®šä¹‰        |
| **Transient**                                     | ç¬æ—¶ï¼šæ¯æ¬¡è§£æéƒ½æ˜¯ä¸€ä¸ªæ–°çš„å®åˆ—  

``` cangjie
let services = ServiceCollection()
services.addScoped<IDbConnection, DbConnection>()
let provider = services.build()//æ ¹å®¹å™¨
//åˆ›å»ºä½œç”¨åŸŸ
try (scope = provider.createScope()){
    //å­å®¹å™¨
    let connection = scope.services.getOrThrow<IDbConnection>()
}
//ä½œç”¨åŸŸç»“æŸæ—¶ä¼šé‡Šæ”¾è¯¥ä½œç”¨åŸŸè§£æçš„éå•ä¾‹çš„å®åˆ—ï¼ˆéœ€è¦å®ç°Resourceæ¥å£ï¼‰ã€‚
```

> æ³¨æ„ï¼šé€šè¿‡`ServiceCollection`ç›´æ¥æ„å»ºçš„ç§°ä¸º`æ ¹å®¹å™¨`,é€šè¿‡`ServiceProvider`åˆ›å»ºçš„scopeå…³è”çš„å®¹å™¨ç§°ä¸º`å­å®¹å™¨`ã€‚æ ¹å®¹å™¨æ— æ³•è§£æéå•ä¾‹çš„æœåŠ¡ã€‚

## ã€Šé€‰é¡¹ã€‹

é€‰é¡¹æ˜¯å¯¹ä¾èµ–æ³¨å…¥æ¨¡å—çš„æ‰©å±•å’Œè¡¥å……ï¼Œç”¨äºç»Ÿä¸€æ¡†æ¶è®¾è®¡è€…å’Œä½¿ç”¨è€…ä¹‹é—´çš„çº¦å®šï¼Œè®¾è®¡è€…é€šè¿‡`configure`æ–¹æ³•è®¾ç½®é»˜è®¤å€¼ï¼Œä½¿ç”¨è€…ä½¿ç”¨è€…é€šè¿‡`configureAfter`æ–¹æ³•ä¿®æ”¹é»˜è®¤å€¼

1. åŸºæœ¬ä½¿ç”¨

``` cangjie
//å®šä¹‰ä¸€ä¸ªé€‰é¡¹
public class DbConnectionOptions {
    var connectionString = "default"
}
//å®šä¹‰å®¹å™¨
let services = ServiceCollection()
services.configureAfter<DbConnectionOptions>{configureOptions =>
    configureOptions.connectionString = "2.1"
}
services.configureAfter<DbConnectionOptions>{configureOptions =>
    configureOptions.connectionString = "2.2"
}
services.configure<DbConnectionOptions>{configureOptions =>
    configureOptions.connectionString = "1.1"
}
services.configure<DbConnectionOptions>{configureOptions =>
    configureOptions.connectionString = "1.2"
}
//æ„å»ºå®¹å™¨
let provider = services.build()
//è§£æé€‰é¡¹
let options = provider.getOrThrow<IOptions<DbConnectionOptions>>()
println(options.value.connectionString)//è¾“å‡º2.2
```
> æ³¨æ„ï¼šä¸Šé¢çš„ç‰ˆæœ¬å·å³æ‰§è¡Œé¡ºåºï¼Œæ— è®ºè§£æå¤šå°‘æ¬¡æ¯ä¸ªlambdaå‡½æ•°åªæ‰§è¡Œä¸€æ¬¡

2. å‘½åé€‰é¡¹

``` cangjie
let services = ServiceCollection()
services.configure<DbConnectionOptions>("tenant1"){configureOptions =>
    configureOptions.connectionString = "1.1"
}
services.configure<DbConnectionOptions>("tenant2"){configureOptions =>
    configureOptions.connectionString = "1.2"
}
let provider = services.build()
let options = provider.getOrThrow<IOptions<DbConnectionOptions>>()
println(options.value.connectionString)
println(options.get("tenant1").connectionString)
println(options.get("tenant2").connectionString)
```
> å‘½åé€‰é¡¹åœ¨å¤šç§Ÿæˆ·ï¼Œå¤šæ¶æ„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨

## ã€Šé…ç½®ã€‹

é…ç½®æ”¯æŒå¤šæ•°æ®æºï¼ˆå‘½ä»¤è¡Œå‚æ•°ï¼Œç¯å¢ƒå˜é‡ï¼Œjsonï¼‰å’Œè‡ªå®šä¹‰æ•°æ®æ¥æºã€‚

``` cangjie
main(args: Array<String>) {
    let configurationBuilder = ConfigurationManager()
    //æ·»åŠ å‘½ä»¤è¡Œå‚æ•°
    configurationBuilder.addArgVars(args)
    //æ·»åŠ â€œasp_â€å¼€å¤´çš„ç¯å¢ƒå˜é‡
    configurationBuilder.addEnvVars("asp")
    //æ·»åŠ jsoné…ç½®
    configurationBuilder.addJsonFile("./appsettings.json", true)
    let configuration = configurationBuilder.build()
    println(configuration["help"])
    println(configuration["port"])
    //å¾ªç¯å¤„ç†æ‰€æœ‰logging:logLevelèŠ‚ç‚¹ä¸‹çš„ç›´æ¥å±æ€§
    for (pattern in configuration.getSection("logging:logLevel").getChildren()) {
        println("${pattern.key}=${pattern.value}")
    }
    return 0
}
```

appsettings.json

``` json
{
    "logging": {
        "logLevel": {
            "default": "Info",
            "aspire": "Error"
        }
    }
}
```

## ã€Šæ—¥å¿—ã€‹

æ—¥å¿—æ¨¡å—ä¹Ÿæ˜¯åº”ç”¨å¼€å‘è¿‡ç¨‹ä¸­å¿…å¤‡å¯å´çš„ç»„ä»¶ï¼Œæ—¥å¿—æ¨¡å—å†…ç½®äº†æ§åˆ¶å°å’Œæ–‡ä»¶æä¾›ç¨‹åºï¼ŒåŒæ ·ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ—¥å¿—æä¾›ç¨‹åº

1. åŸºæœ¬ä½¿ç”¨

``` cangjie
let logFactory = LoggingBuilder()
    .addFile()
    .addConsole()
    .build()
let logger = logFactory.createLogger("aspire.logging.test")    
logger.info("hello")
```

2. ä½¿ç”¨æ—¥å¿—è¿‡æ»¤å™¨

``` cangjie
let logFactory = LoggingBuilder()
    .addFile()
    .addConsole()
    .addFilter{providerName, categoryName, logLevel => 
        (providerName == "file" && logLevel >= LogLevel.Error) || 
        (providerName == "console" && logLevel >= LogLevel.Info)
    }
    .build()
let logger = logFactory.createLogger("aspire.logging.test")    
logger.info("hello")//æ–‡ä»¶ä¸­ä¸æ‰“å°ï¼Œæ§åˆ¶å°ä¸­æ‰“å°
logger.error("hello")//æ–‡ä»¶ä¸­æ‰“å°ï¼Œæ§åˆ¶å°ä¸­æ‰“å°
```

3. ä½¿ç”¨é…ç½®æ–‡ä»¶è¿‡æ»¤

- fileæä¾›ç¨‹åºè¿‡æ»¤è§„åˆ™:ä»¥`asp`ç»“å°¾çš„æ—¥å¿—ï¼Œåªæ‰“å°WarnåŠä»¥ä¸Šçº§åˆ«çš„æ—¥å¿—    
- consoleæä¾›ç¨‹åºè¿‡æ»¤è§„åˆ™:ä»¥`asp`å¼€å¤´çš„æ—¥å¿—ï¼Œåªæ‰“å°InfoåŠä»¥ä¸Šçº§åˆ«çš„æ—¥å¿—    
- é»˜è®¤è¿‡æ»¤è§„åˆ™ï¼šé™¤ä¸Šè¿°ä¹‹å¤–æ‰“å°InfoåŠä»¥ä¸Šçº§åˆ«çš„æ—¥å¿—    

``` cangjie
//åˆ›å»ºé…ç½®
let configurationBuilder = ConfigurationManager()
configurationBuilder.addJsonFile("./appsettings.json", true)
let configuration = configurationBuilder.build()
//åˆ›å»ºæ—¥å¿—å·¥å‚
let logFactory = LoggingBuilder()
    .addFile()
    .addConsole()
    .addConfiguration(configuration.getSection("logging"))
    .build()
//æµ‹è¯•
logFactory.createLogger("aspire.asp").info("hello")    
logFactory.createLogger("asp.aspire").info("hello")  
logFactory.createLogger("cangjie").info("hello")    
```

appsettings.json

``` json
{
    "logging": {
        "logLevel": {
            "default": "Info"
        },
        "file": {
            "logLevel": {
                "*.asp": "Warn"
            }
        },
        "console": {
            "logLevel": {
                "asp.*": "Info"
            }
        }
    }
}
```

## ã€Šé€šç”¨ä¸»æœºã€‹

é€šç”¨ä¸»æœºæ•´åˆäº†ä¸Šè¿°æ‰€æœ‰æ¨¡å—ï¼Œç”¨äºå¤„ç†å®šæ—¶ä»»åŠ¡å’Œæ¶ˆæ¯é˜Ÿåˆ—

1. åˆ›å»ºä¸€ä¸ªå·¥äººå’Œé€‰é¡¹

``` cangjie

public class TestWorkerOptions {
    public var delay = 10
}

public class TestWorker <: BackgroundService {
    private let _logger: ILogger

    public TestWorker(let _options: IOptions<TestWorkerOptions>, let _env: IHostEnvironment, let _logFactory: ILoggerFactory) {
        _logger = _logFactory.createLogger<TestWorker>()
    }
    
    public func run() {

        while (!Thread.currentThread.hasPendingCancellation) {
            //ä¸åŒç¯å¢ƒï¼Œæ‰§è¡Œä¸åŒé€»è¾‘
            if(_env.environmentName == "prod") {
                logger.info("working...")
            }else {
                logger.info("hello...")
            }
            sleep(_options.value.delay * Duration.second)
        }
    }
}
```

2. å®šä¹‰ä¸€ä¸ªæ‰©å±•

``` cangjie
extend ServiceCollection{

    public func addTestWorker(configureOptions: (TestWorkerOptions) -> Unit): ServiceCollection {
        this.addHostedService<TestWorker>()
        this.configure<TestWorkerOptions>(configureOptions)
    }
}
```

3. å¯åŠ¨ä¸»æœº

``` cangjie
main(args: Array<String>) {
    let builder = Host.createBuilder(args)
    
    //æ³¨å†Œæˆ‘ä»¬çš„åå°æœåŠ¡
    builder.services.addTestWorker()
    
    let host = builder.build()
    
    host.run()
    return 0
}
```
> - ä¸»æœºå†…ç½®äº†`IHostEnvironment`æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡è§£æå®ƒæ¥åŒºåˆ†å¼€å‘ç¯å¢ƒè¿˜æ˜¯ç”Ÿæˆç¯å¢ƒ    
> - å¯ä»¥é€šè¿‡`asp_environment`ç¯å¢ƒå˜é‡æˆ–è€…`--environment=test`å‘½ä»¤è¡Œå‚æ•°æ¥ä¿®æ”¹ç¯å¢ƒå

## ã€ŠWebä¸»æœºã€‹

webä¸»æœºå®ç°äº†é€šç”¨ä¸»æœºï¼Œå¹¶ä¸”åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•äº†httpåè®®ï¼Œå†…ç½®è¯·æ±‚ç®¡é“æ¥å¤„ç†è¯·æ±‚é€»è¾‘ã€‚`aspire`ç»„ç»‡æä¾›äº†äº†å¤§é‡çš„ä¸­é—´ä»¶ä¾›å¼€å‘è€…ä½¿ç”¨

### å¯åŠ¨ä¸€ä¸ªæ”¯æŒé™æ€æ–‡ä»¶çš„webä¸»æœº

``` cangjie
main(args: Array<String>) {
    let builder = WebHost.createBuilder(args)
    let host = builder.build()

    //å½“è¯·æ±‚ç½‘ç«™æ ¹è·¯å¾„(/)æ—¶ï¼Œè´Ÿè´£æŸ¥æ‰¾å¹¶è¿”å›index.htmlé¡µé¢
    host.useDefaultFiles()

    //è¯¥ä¸­é—´ä»¶è´Ÿè´£å»wwwrootä¸­æŸ¥æ‰¾å¹¶è¿”å›/xxx.(html|css|js|...)æ–‡ä»¶
    host.useStaticFiles()

    host.run()

    return 0
}
```

### å¯åŠ¨ä¸€ä¸ªæ”¯æŒåŠ¨æ€èµ„æºçš„webä¸»æœº

``` cangjie
main(args: Array<String>) {
    let builder = WebHost.createBuilder(args)

    builder.services.addRouting()//æ³¨å†Œè·¯ç”±ä¸­é—´ä»¶éœ€è¦çš„æœåŠ¡

    let host = builder.build()

    //useEndpointsï¼šä¼šæ³¨å†Œä¸¤ä¸ªä¸­é—´ä»¶ï¼Œä¸€ä¸ªè´Ÿè´£è·¯ç”±ï¼Œä¸€ä¸ªè´Ÿè´£æ‰§è¡Œç»ˆç»“ç‚¹
    host.useEndpoints { endpoints =>
        endpoints.mapGet("hello") {
            context => context.response.write("hello:aspire")
        }   
    }
    host.run()
    return 0
}
```

> - è·¯ç”±ä¸­é—´ä»¶(EndpointRoutingMiddleware)ï¼šè´Ÿè´£æ ¹æ®ç”¨æˆ·è¾“å…¥çš„`uri`æŸ¥æ‰¾å¯¹åº”çš„`Endpoint`å¹¶æ”¾åˆ°`HttpContext`ä¸Šï¼ˆè°ƒç”¨`setEndpoint`ï¼‰
> - ç»ˆç»“ç‚¹ä¸­é—´ä»¶(EndpointMiddleware)ï¼šé€šè¿‡è°ƒç”¨`HttpContext`ä¸Šé¢çš„`getEndpoint()`æ–¹æ³•è·å–ç»ˆç»“ç‚¹ï¼Œå¦‚æœå­˜åœ¨`Endpoint`å°†ä¼šæ‰§è¡Œå®ƒ

### å¥åº·æ£€æŸ¥ä¸­é—´ä»¶

``` cangjie
main(args: Array<String>) {
    let builder = WebHost.createBuilder(args)

    builder.services.addHealthChecks()
        //æ·»åŠ ä¸€ä¸ªå¥åº·æ£€æŸ¥é¡¹
        .addCheck("self") {
            //æ¨¡æ‹Ÿéšæœºä¸å¥åº·æ•ˆæœ
            let random = Random()
            if (random.nextInt32(10) % 2 == 0) {
                HealthCheckResult.healthy()
            } else {
                HealthCheckResult.unhealthy()
            }
        }

    let host = builder.build()

    host.useHealthChecks("/health")

    host.run()

    return 0
}
```

## ã€Šèº«ä»½è®¤è¯ã€‹

### Basicè®¤è¯æ–¹æ¡ˆ

æˆ‘ä»¬åœ¨èº«ä»½è®¤è¯æ¨¡å—ä¸‹å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°ä¸€ä¸ªè®¤è¯æ–¹æ¡ˆï¼Œæ¯”å¦‚`Basic`è®¤è¯æ–¹æ¡ˆã€‚èº«ä»½è®¤è¯æ¨¡å—ä¸ºæˆ‘ä»¬å¤„ç†å¥½äº†è®¤è¯å’Œæˆæƒæµç¨‹

``` cangjie
public class BasicAuthenticationDefault {
    public static let scheme = "basic"
}

public class BasicAuthenticationOptions <: AuthenticationSchemeOptions {
    public var realm = "basic"
}

//å®šä¹‰basicè®¤è¯æ–¹æ¡ˆ
public class BasicAuthenticationHandler <: AuthenticationHandler<BasicAuthenticationOptions> {
    public init(options: IOptions<BasicAuthenticationOptions>, logger: ILoggerFactory) {
        super(options, logger)
    }

    public func handleAuthenticate() {
        if (let Some(authorization) <- this.context.request.headers.getFirst("Authorization")
            .flatMap{f => fromBase64String(f.replace("Basic ", "")).flatMap{f=> String.fromUtf8(f)} }) {
           
            let secrets = authorization.split(":")
            if (secrets.size == 2) {
                let username = secrets[0]
                let password = secrets[1]
                this.logger.info("username:${username},password:${password}")  
                //é€šè¿‡å­å®¹å™¨æ¥è§£æéå•ä¾‹çš„æœåŠ¡ï¼šIResourceOwnerPasswordValidator  
                let validator = this.context.services.getOrThrow<IResourceOwnerPasswordValidator>()
                if (!validator.validate(username, password)) {
                    return AuthenticateResult.fail(Exception("Invalid username or password"))
                }
                let subject = ClaimsPrincipal()
                let identity = ClaimsIdentity(this.scheme.name)
                identity.addClaim(Claim("username",username))
                identity.addClaim(Claim("password",password))
                subject.addIdentity(identity)
                let ticket = AuthenticationTicket(subject, BasicAuthenticationDefault.scheme)
                return AuthenticateResult.success(ticket)
            }
        }
        return AuthenticateResult.noResult()
    }

    /*
    é‡å†™è°ƒæˆ˜å¤„ç†é€»è¾‘:è¿”å›401çŠ¶æ€ç å’ŒBasicåè®®å¤´
    */
    protected override func handleChallenge(properties: ?AuthenticationProperties): Unit {
        this.context.response.addHeader("WWW-Authenticate", "Basic realm=\"${this.options.realm}\", charset=\"UTF-8\"")
        super.handleChallenge(properties)
    }
}

//å®šä¹‰èµ„æºæ‰€æœ‰è€…å‡­æ®éªŒè¯
public interface IResourceOwnerPasswordValidator {
    func validate(username: String, password: String): Bool
}

//å®ç°èµ„æºæ‰€æœ‰è€…å‡­æ®éªŒè¯
public class ResourceOwnerPasswordValidator <: IResourceOwnerPasswordValidator {
    let users = HashMap<String, String>([("aspire", "aspire")])

    public func validate(username: String, password: String) {
        if (!users.contains(username)) {
            return false
        }
        return users[username] == password
    }
}
```

å¯åŠ¨webä¸»æœºæ¥è¿è¡Œ

``` cangjie
main (args: Array<String>) {
    let builder = WebHost.createBuilder(args)

    builder.services.addRouting()
    
    //æ³¨å†Œèµ„æºæ‰€æœ‰è€…éªŒè¯å™¨
    builder.services.addTransient<IResourceOwnerPasswordValidator, ResourceOwnerPasswordValidator>()

    //æ³¨å†Œèº«ä»½è®¤è¯æœåŠ¡
    builder.services.addAuthentication(BasicAuthenticationDefault.scheme)
        //æ³¨å†Œbasicè®¤è¯æ–¹æ¡ˆ
        .addScheme<BasicAuthenticationOptions, BasicAuthenticationHandler>(BasicAuthenticationDefault.scheme)
    
    //æ³¨å†ŒæˆæƒæœåŠ¡
    builder.services.addAuthorizationBuilder()
        //å®šä¹‰æˆæƒç­–ç•¥
        .addPolicy("base-policy"){ policy =>
            //å¿…é¡»åŒ…å«username
            policy.requireClaim("username")
            //åŸºæœ¬è¦æ±‚ï¼Œå…·ä½“å‚è€ƒæºç 
            policy.requireAuthenticatedUser()
        }
    let host = builder.build()

    //å¯ç”¨è®¤è¯ä¸­é—´ä»¶
    host.useAuthentication()

    host.useRouting()

    //å¯ç”¨æˆæƒä¸­é—´ä»¶
    host.useAuthorization()

    host.run()

    host.useEndpoints { endpoints =>
        endpoints.mapGet("logout") {
            context => context.response.write("logout succeeded")
        }
        //å¯ç”¨è®¤è¯ç­–ç•¥
        .requireAuthorization("base-policy") 
    }
    return 0
}
```

> - ç”±äº`æˆæƒä¸­é—´ä»¶`éœ€è¦ä½¿ç”¨è·¯ç”±åˆ°çš„`Endpoint`ï¼Œå¯¹ç»ˆç»“ç‚¹æˆæƒï¼Œå› æ­¤`æˆæƒä¸­é—´ä»¶`å¿…é¡»æ”¾åˆ°`useRouting`åé¢
> - æ³¨æ„ï¼šè®¤è¯æ˜¯ç¡®å®šä½ æ˜¯è°ï¼Œæ— è®ºæˆæœä¸å¦éƒ½ä¸å½±å“æµç¨‹ï¼Œè€Œæˆæƒï¼Œéœ€è¦éªŒè¯ä½ çš„èº«ä»½ï¼Œå¦‚æœèº«ä»½è®¤è¯ä¸é€šè¿‡ï¼Œé‚£ä¹ˆå°†ä¼šå‘èµ·`challenge`ï¼ˆæŒ‘æˆ˜ï¼‰ï¼Œå¹¶è¿”å›401çŠ¶æ€ç ã€‚å¦‚æœèº«ä»½è®¤è¯é€šè¿‡ï¼Œä½†æ˜¯ä¸æ»¡è¶³`æˆæƒç­–ç•¥`å°†ä¼šå‘èµ·`forbid`ï¼ˆç¦æ­¢ï¼‰è¿”å›403çŠ¶æ€ç ã€‚ä½ å¯ä»¥é€šè¿‡overrideæ¥é‡å†™æŒ‘æˆ˜å’Œç¦æ­¢çš„é€»è¾‘
> - webä¸»æœºåœ¨åˆ†å‘è¯·æ±‚çš„æ—¶å€™ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå­å®¹å™¨æ”¾åˆ°`HttpContext`çš„`services`å­—æ®µä¸Šï¼Œè¿›è€Œå®ç°è¯·æ±‚scopeçº§åˆ«çš„ç”Ÿå‘½å‘¨æœŸ

### Jwtè®¤è¯æ–¹æ¡ˆ



```cangjie
main(args: Array<String>): Int64 {

    let builder = WebHost.createBuilder(args)
    //==============æœåŠ¡æ³¨å†Œ==================
	
	//æ³¨å†Œè·¯ç”±
    builder.services.AddRouting()
    
    //æ³¨å†Œèº«ä»½è®¤è¯æ–¹æ¡ˆ
    builder.services.addAuthentication(JwtBearerAuthenticationDefaults.Scheme)
        //æ³¨å†Œbasicè®¤è¯æ–¹æ¡ˆ
        .addScheme<BasicAuthenticationOptions, BasicAuthenticationHandler>(BasicAuthenticationDefault.Scheme)
        //æ³¨å†ŒjwtBearerè®¤è¯æ–¹æ¡ˆ
        .addJwtBearer(JwtBearerAuthenticationDefaults.Scheme) { configureOptions =>
            let securityKey = SymmetricSecurityKey(builder.configuration["authentication:securityKey"].getOrThrow().toArray())
            configureOptions.tokenValidationParameters = TokenValidationParameters(securityKey)
        }
    
    //æ³¨å†ŒæˆæƒæœåŠ¡
    builder.services.addAuthorizationBuilder()
        .addPolicy("default"){ policy =>
            //å¿…é¡»åŒ…å«username
            policy.requireClaim("username")
            //åŸºæœ¬è¦æ±‚ï¼Œå…·ä½“å‚è€ƒæºç 
            policy.requireAuthenticatedUser()
    }

    //==============è¯·æ±‚ç®¡é“==================    
    let host = builder.build()

    //ä½¿ç”¨èº«ä»½è®¤è¯
    host.useAuthentication()

    //åŠ¨æ€èµ„æºè·¯ç”±ï¼ˆè´Ÿè´£è·¯ç”±ï¼Œå¹¶æ”¾åˆ°HttpContextä¸Šï¼‰
    host.useRouting()
    
    //ç”±äºè¯¥ä¸­é—´ä»¶éœ€è¦ä½¿ç”¨è·¯ç”±åˆ°çš„endpointï¼Œå› æ­¤å¿…é¡»æ”¾åˆ°useRoutingåé¢
    host.useAuthorization()
    
    //åŠ¨æ€èµ„æº(è´Ÿè´£æ³¨å†Œå’Œæ‰§è¡Œ)
    host.useEndpoints { endpoints =>
		
        //åˆ›å»ºjwt token
        endpoints.mapGet("connect/token"){ context =>
            let securityKey = SymmetricSecurityKey(host.configuration["authentication:securityKey"].getOrThrow().toArray())
            let jwtHeader = JwtHeader(SigningCredentials(securityKey, SecurityAlgorithms.HmacSha256))
            let jwtPayload = JwtPayload([("sub", "1024"), ("username", "aspire")])
            
            let jwtTokenHander = JwtSecurityTokenHandler()
            let accessToken = jwtTokenHander.writeToken(JwtSecurityToken(jwtHeader, jwtPayload))
            context.response.write(accessToken)
        }
        
        //ç™»å…¥æ¥å£éœ€è¦æˆæƒ
        endpoints.mapGet("connect/logout") {
            context => context.response.write("logout succeeded")
        }.requireAuthorization("default")       
    
    }
    host.run()
    return 0
}
```

